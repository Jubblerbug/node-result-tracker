<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Result Tracker</title>
</head>

<body>
  <h1>Result Tracker</h1>

  <section id="welcome-message" style="display:none;"></section>

  <form id="signup-form" style="display:none;">
    <h2>Sign up</h2>
    <label name="email">email</label>
    <input name="email" type="text" id="signup-email" />

    <label name="password">password</label>
    <input name="password" type="password" id="signup-password" />

    <input type="submit">
  </form>

  <form id="login-form" style="display:none;">
    <h2>Log in</h2>
    <label name="email">email</label>
    <input name="email" type="text" id="login-email" />

    <label name="password">password</label>
    <input name="password" type="password" id="login-password" />

    <input type="submit">
  </form>

  <form id="logout-form" style="display:none;">
    <h2>Log out</h2>
    <input type="submit" value="logout" />
  </form>

  <script>
    const localStorageAuthTokenKey = "NodeResultTracker:x-auth";
    const localStorageUserEmailKey = "NodeResultTracker:user-email";

    const welcomeMessageElement = document.getElementById("welcome-message");

    const signupFormElement     = document.getElementById("signup-form");
    const signupEmailElement    = document.getElementById("signup-email");
    const signupPasswordElement = document.getElementById("signup-password");
    
    const loginFormElement      = document.getElementById("login-form");
    const loginEmailElement     = document.getElementById("login-email");
    const loginPasswordElement  = document.getElementById("login-password");
    
    const logoutFormElement     = document.getElementById("logout-form");

    function hasAuthToken() {
      return localStorage.getItem(localStorageAuthTokenKey)
        ? true
        : false;
    }

    if (hasAuthToken()) {
      logoutFormElement.style.display = "block";
      
      if (localStorage.getItem(localStorageUserEmailKey)) {
        welcomeMessageElement.innerHTML = `Welcome ${localStorage.getItem(localStorageUserEmailKey)}`;
        welcomeMessageElement.style.display = "block";
      }
    } else {
      signupFormElement.style.display = "block";
      loginFormElement.style.display  = "block";
    }
    

    signupFormElement
      .addEventListener("submit", (e) => {
        e.preventDefault();

        const email    = signupEmailElement.value;
        const password = signupPasswordElement.value;

        fetch("/users/", {
          method: "post",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            email,
            password
          })
        })
          .then(resp => {
            if (resp.headers.get("x-auth")) {
              localStorage.setItem(localStorageAuthTokenKey, resp.headers.get("x-auth"));
            }

            return resp.json();
          })
          .then(user => {
            localStorage.setItem(localStorageUserEmailKey, email);
          })
          .catch(console.log);
      })

      loginFormElement
        .addEventListener("submit", (e) => {
          e.preventDefault();

          const email    = loginEmailElement.value;
          const password = loginPasswordElement.value;

          fetch("/users/login/", {
            method: "post",
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              email,
              password
            })
          })
            .then(resp => {
              const authToken = resp.headers.get("x-auth");

              if (authToken)
                localStorage.setItem(localStorageAuthTokenKey, authToken);

              return resp.json();
            })
            .then(user => {
              localStorage.setItem(localStorageUserEmailKey, email);
            })
            .catch(console.log);
        })

    logoutFormElement
      .addEventListener("submit", (e) => {
        e.preventDefault();

        fetch("/users/me/token/", {
          method: "delete",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "x-auth": localStorage.getItem(localStorageAuthTokenKey)
          }
        })
          .then(resp => {
            localStorage.removeItem(localStorageAuthTokenKey);
            localStorage.removeItem(localStorageUserEmailKey);
          })
          .catch(console.log);
      })
  </script>
</body>

</html>